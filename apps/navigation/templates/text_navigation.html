{% extends "base.html" %}

{% block content %}

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">

      <!-- タイトル部分 -->
      <div class="text-center mb-4">
        <span class="badge rounded-pill text-bg-primary mb-2">ことばナビ</span>
        <h1 class="h4 fw-bold mb-1">テキスト案内</h1>
        <p class="text-muted mb-0">
          1ステップずつ、ことばで道順をお伝えします。
        </p>
      </div>

      <!-- サマリーカード -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted small mb-1">合計距離</p>
            <p class="fw-semibold mb-0">
              {{ (text_navigation.total_distance_m / 1000) | round(2) }} km
            </p>
          </div>
          <div class="border-start mx-3" style="height: 32px; opacity:.2;"></div>
          <div>
            <p class="text-muted small mb-1">所要時間</p>
            <p class="fw-semibold mb-0">
              約 {{ (text_navigation.total_duration_s / 60) | round(0) }} 分
            </p>
          </div>
        </div>
      </div>

      <!-- テキスト案内カード -->
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">

          <!-- ステップ表示部分 -->
          <div id="text-navigation" class="mb-3">
            <!-- JSで差し込まれる -->
          </div>

          <!-- ステップ操作ボタン -->
          <div class="d-flex justify-content-between mt-3">
            <button id="prev-step" class="btn btn-outline-secondary" type="button">
              前に戻る
            </button>
            <button id="next-step" class="btn btn-primary" type="button">
              次に進む
            </button>
          </div>

        </div>
      </div>

      <!-- 拡大した地図を常に表示する -->
      <div id="map" style="height: 300px; width: 100%; border-radius: .5rem;"></div>

      <!-- 地図や再設定への導線 -->
      <div class="mt-4">
        <div class="d-grid gap-2">
          <button id="show-map" onclick="location.href='{{ url_for('navigation.show_map') }}'"
            class="btn btn-outline-primary" type="button">
            現在地周辺を大きく表示する
          </button>
          <button onclick="location.href='{{ url_for('navigation.navigation') }}'" class="btn btn-outline-secondary"
            type="button">
            目的地を設定し直す
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ステップを表示するためのスクリプト -->
<script>
  const steps = {{ text_navigation.steps | tojson }};
  let currentIndex = 0;

  // 実ステップの総数（準備ステップを除いた数）
  const normalStepsCount = steps.filter(s => !s.is_prepare).length;

  // ── 距離[m]をざっくり計算する関数 ──
  function distanceMeters(a, b) {
    const R = 6378137;
    const toRad = d => (d * Math.PI) / 180;

    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);

    const A =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(a.lat)) *
      Math.cos(toRad(b.lat)) *
      Math.sin(dLng / 2) * Math.sin(dLng / 2);

    const c = 2 * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
    return R * c;
  }


  function renderStep() {
    const step = steps[currentIndex];
    const container = document.getElementById("text-navigation");

    let badgeLabel;
    let progressPercent;

    if (step.is_prepare) {
      // 準備ステップの表示
      badgeLabel = `ステップ0 / ${normalStepsCount}`;
      progressPercent = 0;
    } else {
      // 実ステップの表示
      const displayIndex = step.step_no; // 1,2,3…
      badgeLabel = `ステップ ${displayIndex} / ${normalStepsCount}`;
      progressPercent = Math.round((displayIndex / normalStepsCount) * 100);
    }

    // 距離表示
    let displayIndex = step.step_no; // 1,2,3…
    if(displayIndex == null){
      displayIndex = 0
    }else{
      displayIndex == displayIndex
    }
    const distanceHtml =
      step.distance_m != null
        ? `この区間は約 <span class="fw-semibold">${step.distance_m} m</span> です。<br>` +
        `地図上の${displayIndex}番まで歩き、次のステップに進んでください。`
        : "";

    container.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <span class="badge rounded-pill text-bg-primary">
        ${badgeLabel}
      </span>
      <small class="text-muted">進捗：${progressPercent}%</small>
    </div>

    <p class="fw-semibold mb-2">
      ${step.instruction}
    </p>
    <p class="text-muted small mb-3" id="step-distance-text">
      ${distanceHtml}
    </p>

    <div class="progress" style="height: 6px;">
      <div
        class="progress-bar"
        role="progressbar"
        style="width: ${progressPercent}%;"
        aria-valuenow="${progressPercent}"
        aria-valuemin="0"
        aria-valuemax="100"
      ></div>
    </div>
  `;

    document.getElementById("prev-step").disabled = currentIndex === 0;
    document.getElementById("next-step").disabled = currentIndex >= steps.length - 1;
  }


  document.getElementById("prev-step").addEventListener("click", () => {
    if (currentIndex > 0) {
      currentIndex -= 1;
      renderStep();
    }
  });

  document.getElementById("next-step").addEventListener("click", () => {
    if (currentIndex < steps.length - 1) {
      currentIndex += 1;
      renderStep();
    }
  });


  // 初期表示 & 自動ナビ開始
  renderStep();
</script>

<!-- サーバーから現在地と目的地を取得（地図描画用） -->
<script>
  const currentLocation = {{ current_location | tojson }};
  const destination = {{ destination | tojson }};
  window.mapZoom = 20;
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}" async></script>
<script type="module" src="{{ url_for('navigation.static', filename='js/initMap.js') }}"></script>

{% endblock %}