{% extends "base.html" %}

{% block content %}

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">

      <!-- タイトル部分 -->
      <div class="text-center mb-4">
        <span class="badge rounded-pill text-bg-primary mb-2">ことばナビ</span>
        <h1 class="h4 fw-bold mb-1">テキスト案内</h1>
        <p class="text-muted mb-0">
          1ステップずつ、ことばで道順をお伝えします。
        </p>
      </div>

      <!-- サマリーカード -->
      <div class="card shadow-sm border-0 mb-4">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <p class="text-muted small mb-1">合計距離</p>
            <p class="fw-semibold mb-0">
              {{ (text_navigation.total_distance_m / 1000) | round(2) }} km
            </p>
          </div>
          <div class="border-start mx-3" style="height: 32px; opacity:.2;"></div>
          <div>
            <p class="text-muted small mb-1">所要時間</p>
            <p class="fw-semibold mb-0">
              約 {{ (text_navigation.total_duration_s / 60) | round(0) }} 分
            </p>
          </div>
        </div>
      </div>

      <!-- テキスト案内カード -->
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">

          <!-- ステップ表示部分 -->
          <div id="text-navigation" class="mb-3">
            <!-- JSで差し込まれる -->
          </div>

          <!-- ステップ操作ボタン -->
          <div class="d-flex justify-content-between mt-3">
            <button id="prev-step" class="btn btn-outline-secondary" type="button">
              前に戻る
            </button>
            <button id="next-step" class="btn btn-primary" type="button">
              次に進む
            </button>
          </div>

        </div>
      </div>

      <!-- 拡大した地図を常に表示する -->
      <div id="map" style="height: 300px; width: 100%; border-radius: .5rem;"></div>


      <!-- 地図や再設定への導線 -->
      <div class="mt-4">
        <div class="d-grid gap-2">
          <button id="show-map" onclick="location.href='{{ url_for('navigation.show_map') }}'"
            class="btn btn-outline-primary" type="button">
            現在地周辺を大きく表示する
          </button>
          <button onclick="location.href='{{ url_for('navigation.navigation') }}'" class="btn btn-outline-secondary"
            type="button">
            目的地を設定し直す
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ステップを表示するためのスクリプト -->
<script>
  const steps = {{ text_navigation.steps | tojson }};
  let currentIndex = 0;

  // ── 距離[m]をざっくり計算する関数 ──
  function distanceMeters(a, b) {
    const R = 6378137;
    const toRad = d => (d * Math.PI) / 180;

    const dLat = toRad(b.lat - a.lat);
    const dLng = toRad(b.lng - a.lng);

    const A =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(toRad(a.lat)) *
      Math.cos(toRad(b.lat)) *
      Math.sin(dLng / 2) * Math.sin(dLng / 2);

    const c = 2 * Math.atan2(Math.sqrt(A), Math.sqrt(1 - A));
    return R * c;
  }

  function renderStep() {
    const step = steps[currentIndex];
    const container = document.getElementById("text-navigation");

    const progressPercent = Math.round(((currentIndex + 1) / steps.length) * 100);

    container.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="badge rounded-pill text-bg-primary">
          ステップ ${currentIndex + 1} / ${steps.length}
        </span>
        <small class="text-muted">進捗：${progressPercent}%</small>
      </div>

      <p class="fw-semibold mb-2">
        ${step.instruction}
      </p>
      <p class="text-muted small mb-3" id="step-distance-text">
        この区間は約 <span class="fw-semibold">${step.distance_m} m</span> です。
      </p>

      <div class="progress" style="height: 6px;">
        <div
          class="progress-bar"
          role="progressbar"
          style="width: ${progressPercent}%;"
          aria-valuenow="${progressPercent}"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>
    `;

    document.getElementById("prev-step").disabled = currentIndex === 0;
    document.getElementById("next-step").disabled = currentIndex >= steps.length - 1;
  }

  document.getElementById("prev-step").addEventListener("click", () => {
    if (currentIndex > 0) {
      currentIndex -= 1;
      renderStep();
    }
  });

  document.getElementById("next-step").addEventListener("click", () => {
    if (currentIndex < steps.length - 1) {
      currentIndex += 1;
      renderStep();
    }
  });

  // ── ここから「現在地に応じて自動ステップ切り替え」ロジック ──

  let watchId = null;

  function startAutoStep() {
    if (!navigator.geolocation) {
      console.warn("この端末は位置情報に対応していません");
      return;
    }

    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
    }

    watchId = navigator.geolocation.watchPosition(
      handlePositionUpdate,
      (err) => {
        console.error("位置情報の取得に失敗しました", err);
      },
      {
        enableHighAccuracy: true,
        maximumAge: 1000,
        timeout: 10000,
      }
    );
  }

  function handlePositionUpdate(position) {
    const userPos = {
      lat: position.coords.latitude,
      lng: position.coords.longitude,
    };

    const step = steps[currentIndex];
    if (!step || !step.end_location) return;

    const endPos = step.end_location;
    const dist = distanceMeters(userPos, endPos);

    // 残り距離を画面に反映（任意）
    const distText = document.getElementById("step-distance-text");
    if (distText) {
      distText.innerHTML =
        `この区間はあと約 <span class="fw-semibold">${Math.round(dist)} m</span> です。`;
    }

    const THRESHOLD = 18; // 何mまで近づいたら次のステップにするか

    if (dist < THRESHOLD) {
      if (currentIndex < steps.length - 1) {
        currentIndex += 1;
        renderStep();
      } else {
        // 最後のステップまで到達
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
        if (distText) {
          distText.textContent = "目的地周辺です。おつかれさまでした。";
        }
      }
    }
  }

  // 初期表示 & 自動ナビ開始
  renderStep();
  startAutoStep();
</script>


<!-- サーバーから現在地と目的地を取得 -->
<script>
  const currentLocation = {{ current_location | tojson }};
  const destination = {{ destination | tojson }};
  window.mapZoom = 20
</script>

<script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}" async></script>
<script type="module" src="{{ url_for('navigation.static', filename='js/initMap.js') }}"></script>


{% endblock %}